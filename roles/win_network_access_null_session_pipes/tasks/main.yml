---
# tasks file for win_network_access_null_session_pipes
- name: Check current NullSessionPipes setting
  ansible.windows.win_shell: |
    $regPath = "HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters"
    $regName = "NullSessionPipes"
    $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
    if ($null -eq $value) {
      Write-Output "NOT_SET"
    } else {
      if ($value -is [System.Array]) {
        $result = $value -join ","
      } else {
        $result = $value.ToString()
      }
      if ([string]::IsNullOrWhiteSpace($result)) {
        Write-Output "EMPTY"
      } else {
        Write-Output $result
      }
    }
  register: win_network_access_null_session_pipes_current_setting
  changed_when: false

- name: Display current NullSessionPipes setting
  ansible.builtin.debug:
    msg: >
      Current NullSessionPipes: {{ win_network_access_null_session_pipes_current_setting.stdout | trim }}
      (NOT_SET/EMPTY=None - no named pipes can be accessed anonymously [recommended], any value=Configured - listed named pipes can be accessed anonymously)

- name: Remove NullSessionPipes registry value to set it to None
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Services\LanManServer\Parameters
    name: NullSessionPipes
    state: absent
  register: win_network_access_null_session_pipes_apply_setting
  when: >
    win_network_access_null_session_pipes_current_setting.stdout | trim not in ["NOT_SET", "EMPTY"]
  changed_when: true

- name: Report if no changes were needed
  ansible.builtin.debug:
    msg: >
      NullSessionPipes is already set to None (value does not exist or is empty),
      which meets the requirement (None - no named pipes can be accessed anonymously)
  when: >
    win_network_access_null_session_pipes_current_setting.stdout | trim in ["NOT_SET", "EMPTY"]
