---
# tasks file for win_audit_other_policy_change_events
- name: Check current Other Policy Change Events audit policy setting
  ansible.windows.win_shell: |
    $output = auditpol.exe /get /subcategory:"Other Policy Change Events" 2>&1
    if ($LASTEXITCODE -ne 0) {
      Write-Error "Failed to get audit policy. Exit code: $LASTEXITCODE"
      Write-Output $output
      exit $LASTEXITCODE
    }
    Write-Output $output
  register: win_audit_other_policy_change_events_current_setting
  changed_when: false

- name: Display current Other Policy Change Events audit policy setting
  ansible.builtin.debug:
    msg: >
      Current Other Policy Change Events audit policy:
      {{ win_audit_other_policy_change_events_current_setting.stdout_lines | join('\n') }}

- name: Check if Failure auditing is enabled
  ansible.builtin.set_fact:
    win_audit_other_policy_change_events_failure_enabled: >
      {{ 'Failure' in win_audit_other_policy_change_events_current_setting.stdout }}

- name: Check if Success auditing is enabled
  ansible.builtin.set_fact:
    win_audit_other_policy_change_events_success_enabled: >
      {{ 'Success' in win_audit_other_policy_change_events_current_setting.stdout }}

- name: Set Other Policy Change Events audit policy to include Failure
  ansible.windows.win_shell: |
    $checkOutput = auditpol.exe /get /subcategory:"Other Policy Change Events" 2>&1
    $successEnabled = $checkOutput -match "Success"
    if ($successEnabled) {
      auditpol.exe /set /subcategory:"Other Policy Change Events" /success:enable /failure:enable
    } else {
      auditpol.exe /set /subcategory:"Other Policy Change Events" /success:disable /failure:enable
    }
    if ($LASTEXITCODE -ne 0) {
      Write-Error "Failed to set audit policy. Exit code: $LASTEXITCODE"
      exit $LASTEXITCODE
    }
    Write-Output "Successfully set Other Policy Change Events audit policy to include Failure"
  register: win_audit_other_policy_change_events_apply_setting
  when: not win_audit_other_policy_change_events_failure_enabled | bool
  changed_when: true

- name: Report if no changes were needed
  ansible.builtin.debug:
    msg: >
      Other Policy Change Events audit policy already includes 'Failure',
      which meets the CIS Benchmark requirement (17.7.5)
  when: win_audit_other_policy_change_events_failure_enabled | bool
