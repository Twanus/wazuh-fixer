---
# tasks file for win_network_access_remotely_accessible_registry_paths_and_subpaths
- name: Check current AllowedPaths Machine setting
  ansible.windows.win_shell: |
    $regPath = "HKLM:\System\CurrentControlSet\Control\SecurePipeServers\Winreg\AllowedPaths"
    $regName = "Machine"
    $value = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue | Select-Object -ExpandProperty $regName
    if ($null -eq $value) {
      Write-Output "NOT_SET"
    } else {
      if ($value -is [System.Array]) {
        $result = ($value | Sort-Object) -join "|"
      } else {
        $result = $value.ToString()
      }
      Write-Output $result
    }
  register: win_network_access_remotely_accessible_registry_paths_and_subpaths_current_setting
  changed_when: false

- name: Display current AllowedPaths Machine setting
  ansible.builtin.debug:
    msg: >
      Current AllowedPaths Machine: {{ win_network_access_remotely_accessible_registry_paths_and_subpaths_current_setting.stdout | trim }}
      (NOT_SET or configured paths - paths and sub-paths that can be accessed remotely)

- name: Build expected paths string for comparison
  ansible.builtin.set_fact:
    win_network_access_remotely_accessible_registry_paths_and_subpaths_expected: "{{ win_network_access_remotely_accessible_registry_paths_and_subpaths_allowed_paths | sort | join('|') }}"
  changed_when: false

- name: Set AllowedPaths Machine to required value
  ansible.windows.win_regedit:
    path: HKLM:\System\CurrentControlSet\Control\SecurePipeServers\Winreg\AllowedPaths
    name: Machine
    data: "{{ win_network_access_remotely_accessible_registry_paths_and_subpaths_allowed_paths }}"
    type: multistring
  register: win_network_access_remotely_accessible_registry_paths_and_subpaths_apply_setting
  when: >
    win_network_access_remotely_accessible_registry_paths_and_subpaths_current_setting.stdout | trim == "NOT_SET" or
    win_network_access_remotely_accessible_registry_paths_and_subpaths_current_setting.stdout | trim != win_network_access_remotely_accessible_registry_paths_and_subpaths_expected
  changed_when: true

- name: Report if no changes were needed
  ansible.builtin.debug:
    msg: >
      AllowedPaths Machine is already configured correctly,
      which meets the requirement (configured with recommended registry paths and sub-paths)
  when: >
    win_network_access_remotely_accessible_registry_paths_and_subpaths_current_setting.stdout | trim != "NOT_SET" and
    win_network_access_remotely_accessible_registry_paths_and_subpaths_current_setting.stdout | trim == win_network_access_remotely_accessible_registry_paths_and_subpaths_expected
