---
# tasks file for win_min_pwd_length
- name: Check current minimum password length
  ansible.windows.win_shell: |
    secedit /export /cfg $env:TEMP\secpol.cfg 2>&1 | Out-Null
    $content = Get-Content $env:TEMP\secpol.cfg | Select-String "MinimumPasswordLength"
    Remove-Item $env:TEMP\secpol.cfg -ErrorAction SilentlyContinue
    if ($content) {
      $value = ($content -split '=')[1].Trim()
      Write-Output $value
    } else {
      Write-Output "0"
    }
  register: win_min_pwd_length_current_minimum_password_length
  changed_when: false

- name: Display current minimum password length
  ansible.builtin.debug:
    msg: "Current minimum password length: {{ win_min_pwd_length_current_minimum_password_length.stdout | trim }} characters"

- name: Set minimum password length using net accounts
  ansible.windows.win_shell: |
    # Use net accounts command which is more reliable than secedit
    # Ensure value is at least 14 characters (CIS requirement)
    $minLength = {{ win_min_pwd_length_minimum_password_length }}
    if ($minLength -lt 14) {
      Write-Error "Minimum password length must be at least 14 characters (CIS requirement)."
      exit 1
    }
    $result = net accounts /minpwlen:$minLength 2>&1
    $exitCode = $LASTEXITCODE
    if ($exitCode -eq 0) {
      Write-Output "Minimum password length policy set to $minLength characters successfully"
    } else {
      Write-Error "Failed to set minimum password length policy. Exit code: $exitCode, Output: $result"
      exit $exitCode
    }
  register: win_min_pwd_length_apply_policy
  when: win_min_pwd_length_current_minimum_password_length.stdout | trim | int < win_min_pwd_length_minimum_password_length | int
  changed_when: true
  notify: Win_min_pwd_length_verify_minimum_password_length

- name: Report if no changes were needed
  ansible.builtin.debug:
    msg: >
      Minimum password length is already set to {{ win_min_pwd_length_current_minimum_password_length.stdout | trim }} characters,
      which meets the requirement (>= {{ win_min_pwd_length_minimum_password_length }} characters)
  when: win_min_pwd_length_current_minimum_password_length.stdout | trim | int >= win_min_pwd_length_minimum_password_length | int
